<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>RS-6</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style type="text/css">
		body {
			background: #000;
			color: #FFF;
			font-family: 'Ubuntu', sans-serif;
		}
		button {
			padding: 8px 12px;
			margin-right: 8px;
			font-size: 14px;
			cursor: pointer;
			border-radius: 4px;
			border: none;
		}
		button.start { background: #2ecc71; color: #000; }
		button.stop  { background: #e74c3c; color: #000; }
    </style>
</head>

<body>
	<div class="row"> <h1 class="heading"> RecoSilbido.  RS-6</h1> </div>


<!-- RECO SILVIDO -->	
	<div class="controls">
		<button class="start" onclick="startRecoSilbido()">Iniciar detección</button>
		<button class="stop" onclick="stopRecoSilbido()"  >Detener detección</button>
	</div> <br>
	<div class="slider-container">
		<label for="sensitivityRange"> Sensibilidad: <span id="sensitivityValue">8</span> </label>
		<input type="range" id="sensitivityRange" min="2" max="35" value="8">
	</div>

	
<!-- WAKELOCK -->	
	  <hr><br>
	  <button id="wakelock-button">Activar Wakelock</button>


<!-- ESPACIO EN NEGRO -->	
	<div style="height: 150vh;" onclick = "cambiaBloque(indiceBloqueActual+1);"></div>

        
<!-- LIBRERÍA -->			
	<script type="text/javascript" src="./whistleDetector.js"></script>


<script>


// __ RECOSILVIDO__

	whistleDetector.setConfig({					// --- Configuración por defecto: ajustable ---
		sampleThreshold : 8   					//(8). Hasta 35 detecta en el PC. 18 para Salón.
	});

	var activoRecoSilvido = true;				// Flag de control para múltiples reconocimientos
	
	function startRecoSilbido(){
		activoRecoSilvido = true;
		whistleDetector.detect(function(){
			if (activoRecoSilvido){
				activoRecoSilvido = false;
				console.log ("Silbido detectado.");
				
				stopRecoSilbido();
				startRecoVoz();				
				//document.body.style.background = "#00FF00";
				//setTimeout (function(){document.body.style.background = "#000000";}, 2*1000);			
			}
		});
	}
	
	function stopRecoSilbido(){
		whistleDetector.stop();	
	}

	const sensitivityRange = document.getElementById("sensitivityRange");
	const sensitivityValue = document.getElementById("sensitivityValue");
	sensitivityRange.addEventListener("input", () => {
		  const nuevoValor = Number(sensitivityRange.value);
		  whistleDetector.setConfig({ sampleThreshold: nuevoValor });
		  sensitivityValue.textContent = sensitivityRange.value;
	});





//_____ PARTE RECOVOZ ____
		
	let escuchandoVoz = false;
	let recognition;
	// Comprobar compatibilidad
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Tu navegador no soporta la API de reconocimiento de voz.");
    } else {
		console.log ("Iniciando SpeechRecognition...");
      recognition = new SpeechRecognition();
      recognition.lang = "es-ES"; 			// idioma español
      recognition.continuous = false; 		// sigue escuchando
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        console.log ("onresult");
		const results = event.results;
        const frase = results[results.length - 1][0].transcript.trim().toLowerCase();
      //  document.getElementById("texto").innerText = "Has dicho: " + frase;
		console.log (frase);
		vozReconocida (frase);
      };

      recognition.onerror = (event) => {
        console.error("Error de reconocimiento: ", event.error);
      };

      recognition.onend = () => {
		console.log ("onend");
		document.body.style.background = "#000000";
		escuchandoVoz = false;
		startRecoSilbido();
      };	
    }
	
	  function startRecoVoz(){
			if (!escuchandoVoz){
				document.body.style.background = "#ff0000";
				escuchandoVoz = true;
				recognition.start();
			}	
		}
	
	

// __ PARTE COMANDOS__
	
	function vozReconocida (comando){			// Palabras clave y acciones
        if (comando.includes("uno") || comando.includes("salón")) {
			envioDatos ('EnviaPorRF,24,1000102#');			  
        }
		if (comando.includes("6") || comando.includes("seis") || comando.includes("ambiente")) {	//
			envioDatos   ('EnviaPorRF,24,3342336#');		// Conmuta 6 (rf3off)	
		}
        if (comando.includes("audio") && comando.includes("bluetooth")) {	//if ((comando.includes("6") || comando.includes("seis")) && comando.includes("enciende")){							
			envioDatos   ('rf4on');
			setTimeout (function(){envioDatos('EnviaPorRF,24,1000070#');}, 2*1000);
		}
		if (comando.includes("audio") && comando.includes("ordenador")) {		
			envioDatos('rf4on');
			setTimeout (function(){envioDatos('EnviaPorRF,24,1000050#');}, 2*1000);
		}
		if (comando.includes("audio") && comando.includes("televisión")) {		
			envioDatos('rf4on');
			setTimeout (function(){envioDatos('EnviaPorRF,24,1000060#');}, 2*1000);
		}
		if (comando.includes("audio") && comando.includes("apaga")) {		
			envioDatos('EnviaPorRF,24,1000090#');
			setTimeout (function(){envioDatos('rf4off');}, 5*1000);
		}
		if ((comando.includes("4") || comando.includes("cuatro")) && comando.includes("apaga")){								
			envioDatos('rf4off');
		}
		if ((comando.includes("2") || comando.includes("dos")) && comando.includes("apaga")){								
			envioDatos('rf2off');
		}
		if ((comando.includes("2") || comando.includes("dos")) && comando.includes("enciende")){								
			envioDatos('rf2on');
		}
		if (comando.includes("habitación") || (comando.includes("2") || comando.includes("dos")) && comando.includes("canal")){								
			envioDatos('rf2on');
			setTimeout (function(){envioDatos('rf2off');}, 10*1000);
		}
		
		if (comando.includes("rojo")) {
          document.body.style.background = "red";
        }
        if (comando.includes("negro")) {
          document.body.style.background = "black";
        }
	}
	


// __ENVÍO DE DATOS__
	
	function envioDatos (datos){
		let ruta = "http://" + "192.168.1.100" + "/" + datos;
		console.log (ruta);
		fetch(ruta, {
			signal: AbortSignal.timeout(2500),
			method: "GET",
			headers: {"Content-type": "text/html"}
		})
		.then(response => response.text()) 	
		.then(respuesta => {console.log("Resp http: " + respuesta);	})
		.catch(err => {console.log("ERROR: " + err); });
	}
	

	
// __PARTE WAKELOCK__

	const button = document.getElementById("wakelock-button");		// Obtenemos una referencia al botón
	let wakelock = null;											// Declaramos una variable para guardar el objeto WakeLockSentinel

	async function requestWakelock() {								// Definimos una función para solicitar un wakelock
		try {
			if ("wakeLock" in navigator) {					        // Comprobamos si el navegador soporta la Wakelock API
				wakelock = await navigator.wakeLock.request("screen");
				console.log("Wakelock activado");
				button.textContent = "Desactivar Wakelock";
				wakelock.addEventListener("release", () => {		// Añadimos un listener para el evento release, para cuando se libera el wakelock                
					button.textContent = "Activar Wakelock";		// Cambiamos el texto del botón
				});
			} else {												// Mostramos un mensaje de error por consola
				console.error("El navegador no soporta la Wakelock API");
			}
		} catch (error) {
			console.error(error);
		}
	}

	async function releaseWakelock() {				// Definimos una función para liberar un wakelock
		if (wakelock) {								// Comprobamos si hay un wakelock activo
			await wakelock.release();				// Y si es así lo liberamos
			wakelock = null;						// Asignamos null a la variable wakelock				
		}
		console.log("Wakelock liberado");
	}

	button.addEventListener("click", () => {		// Añadimos un listener para el evento click del botón para activar o desactivar el wakelock
		if (wakelock) {								// Si ya hay un wakelock activo...
			releaseWakelock();						// ...llamamos a la función para liberar el wakelock
		} else {
			requestWakelock();						// Si no l ohay, llamamos a la función para solicitar el wakelock
		}
	});




























        </script>
    </div>
</body>
</html>

